<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>S-행렬 프레넬 시뮬레이터 | 광학 시뮬레이터</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #050816;
        color: #e5e7eb;
        line-height: 1.6;
      }

      header {
        position: sticky;
        top: 0;
        z-index: 10;
        backdrop-filter: blur(12px);
        background: rgba(5, 8, 22, 0.8);
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      }

      .nav-inner {
        max-width: 960px;
        margin: 0 auto;
        padding: 0.75rem 1.25rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .logo {
        font-weight: 700;
        letter-spacing: 0.05em;
        font-size: 1.05rem;
      }

      .logo span {
        color: #38bdf8;
      }

      .nav-links a {
        margin-left: 1.25rem;
        font-size: 0.9rem;
        text-decoration: none;
        color: #9ca3af;
      }

      .nav-links a:hover {
        color: #e5e7eb;
      }

      main {
        max-width: 960px;
        margin: 0 auto;
        padding: 2.5rem 1.25rem 3.5rem;
      }

      h1 {
        font-size: clamp(1.8rem, 3vw, 2.2rem);
        margin-bottom: 0.75rem;
      }

      .subtitle {
        font-size: 0.95rem;
        color: #9ca3af;
        margin-bottom: 1.5rem;
      }

      .card {
        border-radius: 1.1rem;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.9);
        padding: 1.25rem 1.35rem;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 1rem 1.25rem;
        margin-bottom: 1.25rem;
      }

      label {
        font-size: 0.85rem;
        display: block;
        color: #cbd5f5;
      }

      input[type="number"],
      select {
        margin-top: 0.25rem;
        width: 100%;
        padding: 0.4rem 0.5rem;
        border-radius: 0.4rem;
        border: 1px solid rgba(148, 163, 184, 0.5);
        background: #020617;
        color: #e5e7eb;
      }

      button {
        font-size: 0.9rem;
        padding: 0.55rem 1.1rem;
        border-radius: 999px;
        border: 1px solid transparent;
        cursor: pointer;
        background: linear-gradient(135deg, #0ea5e9, #22c55e);
        color: #0b1120;
        font-weight: 600;
      }

      button:hover {
        filter: brightness(1.05);
      }

      .note {
        margin-top: 0.6rem;
        font-size: 0.8rem;
        color: #9ca3af;
      }

      .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        margin-top: 1.5rem;
        font-size: 0.85rem;
        color: #9ca3af;
        text-decoration: none;
      }

      .back-link:hover {
        color: #e5e7eb;
      }

      footer {
        border-top: 1px solid rgba(148, 163, 184, 0.2);
        padding: 1rem 1.25rem 2rem;
        font-size: 0.75rem;
        color: #6b7280;
        max-width: 960px;
        margin: 0 auto;
      }

      #s-plot-mag,
      #s-plot-phase {
        height: 320px;
        margin-top: 1rem;
      }

      #error-box {
        margin-top: 0.5rem;
        font-size: 0.8rem;
        color: #fca5a5;
      }

      @media (max-width: 640px) {
        .nav-links {
          display: none;
        }

        main {
          padding: 1.75rem 1.1rem 2.5rem;
        }

        .form-grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }
    </style>

    <!-- Plotly (그래프용) CDN -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  </head>
  <body>
    <header>
      <div class="nav-inner">
        <div class="logo">
          광학 <span>시뮬레이터</span>
        </div>
        <nav class="nav-links">
          <a href="index.html">홈으로</a>
        </nav>
      </div>
    </header>

    <main>
      <h1>단일 인터페이스 S-행렬 시뮬레이터</h1>
      <p class="subtitle">
        복소 굴절률 n + i k 를 갖는 두 매질 사이 단일 인터페이스에 대해,
        scattering matrix S = [[S<sub>11</sub>, S<sub>12</sub>],
        [S<sub>21</sub>, S<sub>22</sub>]] 를 계산합니다.<br />
        현재는 n, k를 에너지에 대해 상수로 두고, x축(에너지)을 스캔하면서
        |S<sub>ij</sub>|와 arg S<sub>ij</sub>를 “수평선 형태”로 확인하는
        테스트용 페이지입니다.
      </p>

      <section class="card">
        <h2 style="font-size: 1rem; margin-bottom: 0.6rem">
          설정값 입력
        </h2>

        <div class="form-grid">
          <div>
            <label>
              편광 (s / p)
              <select id="pol-select">
                <option value="s">s-polarization</option>
                <option value="p">p-polarization</option>
              </select>
            </label>
          </div>
          <div>
            <label>
              입사각 θ<sub>i</sub> (deg)
              <input
                type="number"
                id="theta-input"
                value="60"
                min="0"
                max="89"
              />
            </label>
          </div>
          <div>
            <label>
              n<sub>1</sub> (입사측, 실수부)
              <input type="number" id="n1-input" value="1.0" step="0.01" />
            </label>
          </div>
          <div>
            <label>
              k<sub>1</sub> (입사측, 허수부)
              <input type="number" id="k1-input" value="0.0" step="0.01" />
            </label>
          </div>
          <div>
            <label>
              n<sub>2</sub> (전달측, 실수부)
              <input type="number" id="n2-input" value="2.0" step="0.01" />
            </label>
          </div>
          <div>
            <label>
              k<sub>2</sub> (전달측, 허수부)
              <input type="number" id="k2-input" value="0.0" step="0.01" />
            </label>
          </div>
          <div>
            <label>
              E<sub>min</sub> (eV, x축 시작)
              <input
                type="number"
                id="emin-input"
                value="1.5"
                step="0.01"
              />
            </label>
          </div>
          <div>
            <label>
              E<sub>max</sub> (eV, x축 끝)
              <input
                type="number"
                id="emax-input"
                value="3.0"
                step="0.01"
              />
            </label>
          </div>
          <div>
            <label>
              에너지 샘플 수 (points)
              <input
                type="number"
                id="points-input"
                value="100"
                min="10"
                max="600"
              />
            </label>
          </div>
        </div>

        <button id="plot-btn">
          S-행렬 4요소 |S<sub>ij</sub>|, arg S<sub>ij</sub> 계산 및 그래프 그리기
        </button>

        <div id="error-box"></div>

        <p class="note">
          ※ 단일 인터페이스이기 때문에, n<sub>1</sub>, k<sub>1</sub>,
          n<sub>2</sub>, k<sub>2</sub>가 상수이면 S-행렬도 에너지에 대해 상수입니다.
          따라서 그래프는 수평선처럼 나오는 것이 정상입니다. 이후 n(E), k(E)를
          넣으면 S(E) 형태가 생깁니다.
        </p>

        <h3 style="font-size: 0.95rem; margin-top: 1.2rem">
          |S<sub>11</sub>|, |S<sub>12</sub>|, |S<sub>21</sub>|, |S<sub>22</sub>| vs
          Energy
        </h3>
        <div id="s-plot-mag"></div>

        <h3 style="font-size: 0.95rem; margin-top: 1.2rem">
          arg S<sub>11</sub>, arg S<sub>12</sub>, arg S<sub>21</sub>, arg
          S<sub>22</sub> vs Energy (deg)
        </h3>
        <div id="s-plot-phase"></div>
      </section>

      <a href="index.html" class="back-link"> ← 메인 페이지로 돌아가기 </a>
    </main>

    <footer>
      © <span id="year"></span> 광학 시뮬레이터 · Web Optical Simulator.
      All rights reserved.
    </footer>

    <script>
      // 연도 표시
      (function () {
        var y = document.getElementById("year");
        if (y) {
          y.textContent = new Date().getFullYear();
        }
      })();

      // --- 복소수 유틸리티 ---
      function Complex(re, im) {
        this.re = re;
        this.im = im;
      }

      Complex.from = function (re, im) {
        return new Complex(re, im);
      };

      Complex.one = function () {
        return new Complex(1, 0);
      };

      Complex.prototype.add = function (o) {
        return new Complex(this.re + o.re, this.im + o.im);
      };

      Complex.prototype.sub = function (o) {
        return new Complex(this.re - o.re, this.im - o.im);
      };

      Complex.prototype.mul = function (o) {
        return new Complex(
          this.re * o.re - this.im * o.im,
          this.re * o.im + this.im * o.re
        );
      };

      Complex.prototype.mulReal = function (a) {
        return new Complex(this.re * a, this.im * a);
      };

      Complex.prototype.div = function (o) {
        var den = o.re * o.re + o.im * o.im;
        return new Complex(
          (this.re * o.re + this.im * o.im) / den,
          (this.im * o.re - this.re * o.im) / den
        );
      };

      Complex.prototype.abs = function () {
        return Math.hypot(this.re, this.im);
      };

      Complex.prototype.arg = function () {
        return Math.atan2(this.im, this.re);
      };

      Complex.prototype.square = function () {
        return this.mul(this);
      };

      Complex.prototype.sqrt = function () {
        var x = this.re;
        var y = this.im;
        var r = Math.hypot(x, y);
        if (r === 0) return new Complex(0, 0);
        var u = Math.sqrt((r + x) / 2);
        var v = Math.sqrt((r - x) / 2);
        if (y >= 0) return new Complex(u, v);
        return new Complex(u, -v);
      };

      function degToRad(deg) {
        return (deg * Math.PI) / 180;
      }

      // --- 프레넬 계수 (복소 굴절률, 단일 인터페이스, s/p 공통) ---
      function fresnel_interface(n1, n2, thetaI, pol) {
        var sinI = Math.sin(thetaI);
        var cosI = Math.cos(thetaI);

        // Snell: n1 sinθ1 = n2 sinθ2
        var n1_sinI = n1.mulReal(sinI);
        var sinT = n1_sinI.div(n2);

        var one = Complex.one();
        var cosT = one.sub(sinT.square()).sqrt();

        var n1_cosI = n1.mulReal(cosI);
        var n2_cosT = n2.mul(cosT);
        var n2_cosI = n2.mulReal(cosI);
        var n1_cosT = n1.mul(cosT);

        var r12, t12, r21, t21;

        if (pol === "s") {
          // s 편광
          var den_s = n1_cosI.add(n2_cosT);
          r12 = n1_cosI.sub(n2_cosT).div(den_s);
          t12 = n1_cosI.mulReal(2).div(den_s);

          // 반대 방향
          r21 = n2_cosT.sub(n1_cosI).div(den_s); // = -r12
          t21 = n2_cosT.mulReal(2).div(den_s);
        } else {
          // p 편광
          var den_p = n2_cosI.add(n1_cosT);
          r12 = n2_cosI.sub(n1_cosT).div(den_p);
          t12 = n1_cosI.mulReal(2).div(den_p);

          r21 = n1_cosT.sub(n2_cosI).div(den_p);
          t21 = n2_cosT.mulReal(2).div(den_p);
        }

        return { r12: r12, t12: t12, r21: r21, t21: t21 };
      }

      // S-행렬 구성
      // [b1]   [S11 S12][a1]
      // [b2] = [S21 S22][a2]
      function scattering_matrix(n1, n2, thetaI, pol) {
        var fr = fresnel_interface(n1, n2, thetaI, pol);
        var S11 = fr.r12;
        var S21 = fr.t12;
        var S22 = fr.r21;
        var S12 = fr.t21;
        return { S11: S11, S12: S12, S21: S21, S22: S22 };
      }

      document.addEventListener("DOMContentLoaded", function () {
        var polSelect = document.getElementById("pol-select");
        var thetaInput = document.getElementById("theta-input");
        var n1Input = document.getElementById("n1-input");
        var k1Input = document.getElementById("k1-input");
        var n2Input = document.getElementById("n2-input");
        var k2Input = document.getElementById("k2-input");
        var eminInput = document.getElementById("emin-input");
        var emaxInput = document.getElementById("emax-input");
        var pointsInput = document.getElementById("points-input");
        var plotBtn = document.getElementById("plot-btn");
        var errorBox = document.getElementById("error-box");

        plotBtn.addEventListener("click", function () {
          errorBox.textContent = "";

          var pol = polSelect.value;
          var thetaDeg = parseFloat(thetaInput.value);
          var n1Re = parseFloat(n1Input.value);
          var k1Im = parseFloat(k1Input.value);
          var n2Re = parseFloat(n2Input.value);
          var k2Im = parseFloat(k2Input.value);
          var Emin = parseFloat(eminInput.value);
          var Emax = parseFloat(emaxInput.value);
          var points = parseInt(pointsInput.value, 10);

          if (
            !isFinite(thetaDeg) ||
            !isFinite(n1Re) ||
            !isFinite(k1Im) ||
            !isFinite(n2Re) ||
            !isFinite(k2Im) ||
            !isFinite(Emin) ||
            !isFinite(Emax)
          ) {
            errorBox.textContent = "입력값을 다시 확인해주세요.";
            return;
          }

          if (Emax <= Emin) {
            errorBox.textContent = "Emax는 Emin보다 커야 합니다.";
            return;
          }

          if (!isFinite(points) || points < 10) points = 10;
          if (points > 600) points = 600;

          var thetaI = degToRad(thetaDeg);
          var n1 = Complex.from(n1Re, k1Im);
          var n2 = Complex.from(n2Re, k2Im);

          var S = scattering_matrix(n1, n2, thetaI, pol);
          var S11 = S.S11;
          var S12 = S.S12;
          var S21 = S.S21;
          var S22 = S.S22;

          var energies = [];
          var S11MagArr = [];
          var S12MagArr = [];
          var S21MagArr = [];
          var S22MagArr = [];

          var S11PhaseArr = [];
          var S12PhaseArr = [];
          var S21PhaseArr = [];
          var S22PhaseArr = [];

          for (var i = 0; i < points; i++) {
            var t = points === 1 ? 0 : i / (points - 1);
            var E = Emin + (Emax - Emin) * t;

            energies.push(E);

            S11MagArr.push(S11.abs());
            S12MagArr.push(S12.abs());
            S21MagArr.push(S21.abs());
            S22MagArr.push(S22.abs());

            S11PhaseArr.push((S11.arg() * 180) / Math.PI);
            S12PhaseArr.push((S12.arg() * 180) / Math.PI);
            S21PhaseArr.push((S21.arg() * 180) / Math.PI);
            S22PhaseArr.push((S22.arg() * 180) / Math.PI);
          }

          // |S_ij| 그래프
          var traceMag11 = {
            x: energies,
            y: S11MagArr,
            name: "|S11|",
            mode: "lines",
          };
          var traceMag12 = {
            x: energies,
            y: S12MagArr,
            name: "|S12|",
            mode: "lines",
          };
          var traceMag21 = {
            x: energies,
            y: S21MagArr,
            name: "|S21|",
            mode: "lines",
          };
          var traceMag22 = {
            x: energies,
            y: S22MagArr,
            name: "|S22|",
            mode: "lines",
          };

          var layoutMag = {
            margin: { t: 20, r: 10, b: 45, l: 50 },
            xaxis: { title: "Energy (eV)" },
            yaxis: { title: "|S_ij|" },
            legend: { x: 0.02, y: 0.98 },
            paper_bgcolor: "rgba(0,0,0,0)",
            plot_bgcolor: "rgba(15,23,42,0.9)",
            font: { color: "#e5e7eb" },
          };

          Plotly.newPlot(
            "s-plot-mag",
            [traceMag11, traceMag12, traceMag21, traceMag22],
            layoutMag,
            { responsive: true }
          );

          // 위상 그래프
          var tracePhase11 = {
            x: energies,
            y: S11PhaseArr,
            name: "arg S11",
            mode: "lines",
          };
          var tracePhase12 = {
            x: energies,
            y: S12PhaseArr,
            name: "arg S12",
            mode: "lines",
          };
          var tracePhase21 = {
            x: energies,
            y: S21PhaseArr,
            name: "arg S21",
            mode: "lines",
          };
          var tracePhase22 = {
            x: energies,
            y: S22PhaseArr,
            name: "arg S22",
            mode: "lines",
          };

          var layoutPhase = {
            margin: { t: 20, r: 10, b: 45, l: 50 },
            xaxis: { title: "Energy (eV)" },
            yaxis: { title: "Phase (deg)" },
            legend: { x: 0.02, y: 0.98 },
            paper_bgcolor: "rgba(0,0,0,0)",
            plot_bgcolor: "rgba(15,23,42,0.9)",
            font: { color: "#e5e7eb" },
          };

          Plotly.newPlot(
            "s-plot-phase",
            [tracePhase11, tracePhase12, tracePhase21, tracePhase22],
            layoutPhase,
            { responsive: true }
          );
        });
      });
    </script>
  </body>
</html>
